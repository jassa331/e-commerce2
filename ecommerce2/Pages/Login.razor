@page "/"
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="container">
    <div class="login-box">
        <h1 style="color:black;">Login Account</h1>

        <div class="logo-container">
            <img src="images/logo.png" alt="Logo" class="logo" />
        </div>

        <input type="text" placeholder="Enter username" @bind="loginModel.username" required />
        <input type="password" placeholder="Enter password" @bind="loginModel.password" required />

        <button class="myButton" @onclick="LoginUser">Login</button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color:red;">@errorMessage</p>
        }
    </div>
</div>


@code {
    private LoginModel loginModel = new();
    private string? errorMessage;

    private async Task LoginUser()
    {
        try
        {
            using var http = new HttpClient { BaseAddress = new Uri("https://localhost:7008/") };
            var response = await http.PostAsJsonAsync("api/JWTAuthentication/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();


                if (result.Role == "Admin")
                    Navigation.NavigateTo("/admin-dashboard");
                else if (result.Role == "user")
                    Navigation.NavigateTo("/user-dashboard");
            }
            else
            {
                errorMessage = "Invalid username or password.";
            }

        }
        catch
        {
            errorMessage = "Failed to connect to server.";
        }
    }

    [Inject] NavigationManager NavigationManager { get; set; }

    public class LoginModel
    {
        public string username { get; set; }
        public string password { get; set; }
    }


public class LoginResponse
{
    [JsonPropertyName("token")]
    public string Token { get; set; }

    [JsonPropertyName("role")]
    public string Role { get; set; }
}

}
